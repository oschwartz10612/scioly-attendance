<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Science Olympiad Attendance Data</title>
    <link rel="shortcut icon" href="./res/img/favicon.png" type="image/x-icon">
    <link rel="stylesheet" href="./res/css/bootstrap-material-design.min.css">
  </head>
  <body>

    <div class="container" id="logged_in" style="display: none;">
        <button class="btn btn-outline-primary" id="logout">Logout</button>

    </div>

    <div class="container" id="logged_out" style="display: none;">
        <button class="btn btn-outline-primary" id="login">Login with a Google Account</button>
    </div>

    <div class="container" id="fail" style="display: none;">
      <div class="jumbotron">
        <h1 class="display-3">Authorization Error</h1>
        <p class="lead">You are not authorized to view this page</p>
        <hr class="my-2">
        <button class="btn btn-outline-primary" id="logout">Logout</button>
      </div>
    </div>

    <div class="container" id="error" style="display: none;">
      <div class="jumbotron">
        <h1 class="display-3">Error</h1>
        <p class="lead">There was an error</p>
        <hr class="my-2">
        <p>Please contact an administrator...</p>
      </div>
    </div>

    <div class="container" id="viewport">

    </div>

   </body>
</html>

<!-- update the version number as needed -->
<script src="/__/firebase/7.5.2/firebase-app.js"></script>
<!-- include only the Firebase features as you need -->
<script src="/__/firebase/7.5.2/firebase-auth.js"></script>
<script src="/__/firebase/7.5.2/firebase-firestore.js"></script>
<!-- initialize the SDK after all desired features are loaded -->
<script src="/__/firebase/init.js"></script>

<script>

  try {
    let app = firebase.app()
    let features = ['auth', 'firestore'].filter(feature => typeof app[feature] === 'function')
  } catch (e) {
    console.error(e)
  }

  var provider = new firebase.auth.GoogleAuthProvider()
  var db = firebase.firestore()

  var login = document.getElementById('login')
  var logout = document.querySelectorAll('#logout')

  var logged_in = document.getElementById('logged_in')
  var logged_out = document.getElementById('logged_out')
  var fail = document.getElementById('fail')
  var errorCard = document.getElementById('error')
  var viewport = document.getElementById('viewport')

  login.addEventListener('click', () => {
    firebase.auth().signInWithRedirect(provider).then(function(result) {
      // This gives you a Google Access Token. You can use it to access the Google API.
      var token = result.credential.accessToken
      // The signed-in user info.
      var user = result.user
      // ...
    }).catch(function(error) {
      // Handle Errors here.
      var errorCode = error.code
      var errorMessage = error.message
      console.log(errorMessage)
      logged_out.style.display = 'none'
      logged_in.style.display = 'none'  
      fail.style.display = 'none'  
      errorCard.style.display = 'block'  
      
    })
  })

  logout.addEventListener('click', () => {
    firebase.auth().signOut().then(function() {
      logged_out.style.display = 'block'
      logged_in.style.display = 'none'  
    }).catch(function(error) {
      logged_out.style.display = 'none'
      logged_in.style.display = 'none'  
      fail.style.display = 'none'  
      errorCard.style.display = 'block'  
    })
  })



      db.collection('Q1').get().then(doc => {
        doc.forEach(doc => {
          var card = document.createElement('div')
          card.setAttribute("id", doc.data().name)
          card.setAttribute("class", "card")
          
          var card_body = document.createElement('div')
          card_body.setAttribute("class", "card-body")
          card_body.textContent = doc.data().name
          card.appendChild(card_body)
          viewport.appendChild(card)

        });
      })
      

      // people.forEach(person => {
      //     db.collection('Q1').doc(person).collection('meetings').get().then(meetings => {
      //       meetings.forEach(doc => {
      //         doc.data().meeting
      //       });
            
      //     })
      //   })

      firebase.auth().onAuthStateChanged(user => {
        if(user) {
          if (user.email == 'roboscienceolympiad@gmail.com') {
            logged_out.style.display = 'none'
            logged_in.style.display = 'block'
          } else {
            fail.style.display = 'block';
          }
        } else {
          logged_out.style.display = 'block'
          logged_in.style.display = 'none'  
        }
      })

</script>
